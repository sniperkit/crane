/*!
 * Linker, Node Editor Library v0.0.1
 * https://github.com/m-reda/linker
 *
 *
 * Released under the MIT license
 *
 * Date: 2017-03-19
 */
!function(t){t.fn.linker=function(e){function n(){return c++,Math.random().toString(36)+c}function a(t,e,n,a){var o=s.offset();t-=o.left,e-=o.top,n-=o.left,a-=o.top;var i=Math.abs(t-n)/2;return e+=5,a+=5," M"+t+","+e+" C"+(t+i)+","+e+" "+(n-i)+","+a+" "+n+","+a+" l-1 0 l-5 -5 m5 5 l-5 5"}function o(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d",a(t.left,t.top,e.left,e.top)),document.getElementById("linker_paths").appendChild(n),n}var s=t('<div class="linker_board"><svg id="linker_paths"></svg></div>').appendTo(this),i=t.extend({settingIcon:!0},e),l=t(this).addClass("linker_container"),c=Date.now();this.node=function(e){var a=e||{x:0,y:0};return a.__id=n(),a.id=a.id?a.id:a.__id,a.el=t('<div class="linker_node node_'+a.id+'" style="left:'+a.x+"px;top: "+a.y+'px;"><h3>'+a.name+' <span class="remove"></span></h3><div class="linker_inputs"></div><div class="linker_outputs"></div></div>'),a.el.data("obj",a),a.pathsOut={},a.pathsIn={},t("h3 .remove",a.el).click(function(){confirm("Delete this node?")&&(a.el.remove(),t.each(a.pathsOut,function(e,n){t.each(n,function(e,n){t(n[0]).remove()})}),t.each(a.pathsIn,function(e,n){t.each(n,function(e,n){t(n[0]).trigger("click",!0)})}),a.onRemove&&a.onRemove())}),a.inputs=[],a.input=function(e,o){var s=a.inputs.push({__id:n(),id:e,name:o,node:a,el:t('<div class="linker_point" data-type="input"></div>')}),i=a.inputs[s-1];i.el.data("obj",i),a.pathsIn[i.__id]=[];var l=t('<div class="linker_label"><span>'+o+"</span></span></div>").append(i.el);return t(".linker_inputs",a.el).append(l),i},a.outputs=[],a.output=function(e,s){var i=a.outputs.push({__id:n(),id:e,name:s,node:a,el:t('<div class="linker_point" data-type="output"></div>')}),l=a.outputs[i-1];l.el.data("obj",l),a.pathsOut[l.__id]=[],l.connect=function(e,n){for(var s=a.pathsOut[this.__id],i=0;i<s.length;i++)if(e.__id===s[i][2].__id)return;var c=o(this.el.offset(),e.el.offset()),r=[c,this,e];s.push(r),e.node.pathsIn[e.__id].push(r),!n&&this.onConnect&&this.onConnect(e),t(c).on("click",function(n,o){if(o||confirm("Delete this path?")){var s=a.pathsOut[l.__id].indexOf(r);a.pathsOut[l.__id].splice(s,1),e.node.pathsIn[e.__id].splice(1,1),t(this).remove(),l.onRemove&&l.onRemove(s)}})};var c=t('<div class="linker_label"><span>'+s+"</span></div>").append(l.el);return t(".linker_outputs",a.el).append(c),l},i.settingIcon&&t('<svg class="setting" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 54 54" xml:space="preserve"><path d="M51.22,21h-5.052c-0.812,0-1.481-0.447-1.792-1.197s-0.153-1.54,0.42-2.114l3.572-3.571 c0.525-0.525,0.814-1.224,0.814-1.966c0-0.743-0.289-1.441-0.814-1.967l-4.553-4.553c-1.05-1.05-2.881-1.052-3.933,0l-3.571,3.571 c-0.475,0.475-0.997,0.574-1.352,0.574c-0.5,0-0.997-0.196-1.364-0.539C33.324,8.984,33,8.534,33,7.832V2.78 C33,1.247,31.753,0,30.22,0H23.78C22.247,0,21,1.247,21,2.78v5.052c0,1.218-0.997,1.945-1.961,1.945c-0.354,0-0.876-0.1-1.351-0.574 l-3.571-3.571c-1.052-1.052-2.883-1.05-3.933,0l-4.553,4.553c-0.525,0.525-0.814,1.224-0.814,1.967c0,0.742,0.289,1.44,0.814,1.966 l3.572,3.571c0.573,0.574,0.73,1.364,0.42,2.114S8.644,21,7.832,21H2.78C1.247,21,0,22.247,0,23.78v6.438C0,31.752,1.247,33,2.78,33 h5.052c0.812,0,1.481,0.447,1.792,1.197s0.153,1.54-0.42,2.114l-3.572,3.571c-0.525,0.525-0.814,1.224-0.814,1.966 c0,0.743,0.289,1.441,0.814,1.967l4.553,4.553c1.051,1.051,2.881,1.053,3.933,0l3.571-3.571c0.475-0.475,0.997-0.574,1.352-0.574 c0.963,0,1.96,0.728,1.96,1.945v5.051C21,52.752,22.247,54,23.78,54h6.439c1.533,0,2.78-1.248,2.78-2.781v-5.051 c0-1.218,0.997-1.945,1.96-1.945c0.354,0,0.877,0.1,1.352,0.574l3.571,3.571c1.052,1.052,2.883,1.05,3.933,0l4.553-4.553 c0.525-0.525,0.814-1.224,0.814-1.967c0-0.742-0.289-1.44-0.814-1.966l-3.572-3.571c-0.573-0.574-0.73-1.364-0.42-2.114 S45.356,33,46.168,33h5.052c1.533,0,2.78-1.248,2.78-2.781V23.78C54,22.247,52.753,21,51.22,21z M34,27c0,3.859-3.141,7-7,7 s-7-3.141-7-7s3.141-7,7-7S34,23.141,34,27z"/><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>').appendTo(t("h3",a.el)).click(function(){a.onSetting&&a.onSetting()}),s.append(a.el),a};var r,p,d;s.on("click",function(e){var n=t(e.target),a=n.hasClass("linker_point"),i="output"===n.data("type");if(r){if(a&&!i){var l=r.data("obj"),c=n.data("obj");l.node!==c.node&&l.connect(c)}return r.removeClass("selected"),r=null,t(p).remove(),p=null,void s.removeClass("drag_path")}a&&i&&(r=t(e.target).addClass("selected"),d=r.offset(),p=o(d,d),s.addClass("drag_path"))});var u,h=0;return s.on("mousedown touchstart",".linker_node > h3",function(e){"touchstart"===e.type&&l.css("overflow","hidden"),e.target===this&&(u=t(e.target).parent(),h=u.width()/2)}).on("mouseup touchend",function(t){if("touchend"===t.type&&l.css("overflow","auto"),u){var e=u.data("obj");e.onDragFinish&&e.onDragFinish(parseInt(u.css("left")),parseInt(u.css("top")))}u=null}).on("mousemove touchmove",function(e){if(u){u.offset({top:e.pageY-10,left:e.pageX-h}).trigger("drag");var n=u.data("obj"),o=t.extend(t.extend({},n.pathsOut),n.pathsIn);t.each(o,function(e,n){t.each(n,function(e,n){var o=n[1].el.offset(),s=n[2].el.offset();t(n[0]).attr("d",a(o.left,o.top,s.left,s.top))})}),n.onDrag&&n.onDrag(parseInt(u.css("left")),parseInt(u.css("top")))}p&&t(p).attr("d",a(d.left,d.top,e.pageX-5,e.pageY-5))}),this}}(jQuery);